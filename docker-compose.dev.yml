version: '3.8'

services:
  postgres:
    extends:
      file: docker-compose.yml
      service: postgres

  # 后端开发容器 (支持增量更新)
  backend-dev:
    build:
      context: .
      dockerfile: Dockerfile.dev
      target: backend-development
    image: mumuainovel-backend-dev:latest
    container_name: mumuainovel-backend-dev
    depends_on:
      postgres:
        condition: service_healthy
    ports:
      - "${APP_PORT:-8000}:8000"
    volumes:
      # 后端代码热重载
      - ./backend:/app/backend
      # 日志挂载
      - ./logs:/app/logs
      # 环境配置
      - ./.env:/app/.env:ro
      # 缓存node_modules（避免重复安装）
      - backend-node-modules:/app/backend/node_modules
    environment:
      # 开发环境标识
      - NODE_ENV=development
      - DEBUG=true

      # 数据库配置
      - DATABASE_URL=postgresql+asyncpg://${POSTGRES_USER:-mumuai}:${POSTGRES_PASSWORD:-mumuai_password_2024}@postgres:5432/${POSTGRES_DB:-mumuai_novel}

      # 数据库连接池配置
      - DATABASE_POOL_SIZE=${DATABASE_POOL_SIZE:-30}
      - DATABASE_MAX_OVERFLOW=${DATABASE_MAX_OVERFLOW:-20}
      - DATABASE_POOL_TIMEOUT=${DATABASE_POOL_TIMEOUT:-60}
      - DATABASE_POOL_RECYCLE=${DATABASE_POOL_RECYCLE:-1800}
      - DATABASE_POOL_PRE_PING=${DATABASE_POOL_PRE_PING:-True}
      - DATABASE_POOL_USE_LIFO=${DATABASE_POOL_USE_LIFO:-True}

      # 代理配置
      - HTTP_PROXY=${HTTP_PROXY:-}
      - HTTPS_PROXY=${HTTPS_PROXY:-}
      - NO_PROXY=${NO_PROXY:-localhost,127.0.0.1}

      # AI 服务配置
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - OPENAI_BASE_URL=${OPENAI_BASE_URL:-https://api.openai.com/v1}
      - GEMINI_API_KEY=${GEMINI_API_KEY:-}
      - GEMINI_BASE_URL=${GEMINI_BASE_URL:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - ANTHROPIC_BASE_URL=${ANTHROPIC_BASE_URL:-}
      - DEFAULT_AI_PROVIDER=${DEFAULT_AI_PROVIDER:-openai}
      - DEFAULT_MODEL=${DEFAULT_MODEL:-gpt-4o-mini}
      - DEFAULT_TEMPERATURE=${DEFAULT_TEMPERATURE:-0.7}
      - DEFAULT_MAX_TOKENS=${DEFAULT_MAX_TOKENS:-2000}

      # LinuxDO OAuth 配置
      - LINUXDO_CLIENT_ID=${LINUXDO_CLIENT_ID:-11111}
      - LINUXDO_CLIENT_SECRET=${LINUXDO_CLIENT_SECRET:-11111}
      - LINUXDO_REDIRECT_URI=${LINUXDO_REDIRECT_URI:-http://localhost:8000/api/auth/linuxdo/callback}
      - FRONTEND_URL=${FRONTEND_URL:-http://localhost:8000}

      # 本地账户登录配置
      - LOCAL_AUTH_ENABLED=${LOCAL_AUTH_ENABLED:-true}
      - LOCAL_AUTH_USERNAME=${LOCAL_AUTH_USERNAME:-admin}
      - LOCAL_AUTH_PASSWORD=${LOCAL_AUTH_PASSWORD:-admin123}
      - LOCAL_AUTH_DISPLAY_NAME=${LOCAL_AUTH_DISPLAY_NAME:-本地管理员}

      # 会话配置
      - SESSION_EXPIRE_MINUTES=${SESSION_EXPIRE_MINUTES:-120}
      - SESSION_REFRESH_THRESHOLD_MINUTES=${SESSION_REFRESH_THRESHOLD_MINUTES:-30}

      # 前端开发服务器地址
      - FRONTEND_DEV_SERVER=http://frontend-dev:3000

    restart: unless-stopped
    networks:
      - ai-story-network

  # 前端开发容器 (热重载)
  frontend-dev:
    build:
      context: .
      dockerfile: Dockerfile.dev
      target: frontend-development
    image: mumuainovel-frontend-dev:latest
    container_name: mumuainovel-frontend-dev
    ports:
      - "3000:3000"  # React开发服务器端口
    volumes:
      # 前端代码热重载
      - ./frontend:/frontend
      # 缓存node_modules
      - frontend-node-modules:/frontend/node_modules
      # 构建输出共享给后端
      - frontend-dist:/frontend/dist
    environment:
      - NODE_ENV=development
      - REACT_APP_API_URL=http://localhost:8000
      - CHOKIDAR_USEPOLLING=true  # Docker环境下的文件监听
      - FAST_REFRESH=true
    restart: unless-stopped
    networks:
      - ai-story-network

volumes:
  # 缓存卷避免重复安装依赖
  backend-node-modules:
    driver: local
  frontend-node-modules:
    driver: local
  frontend-dist:
    driver: local

networks:
  ai-story-network:
    driver: bridge