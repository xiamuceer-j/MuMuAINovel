# 开发模式使用指南

## 🚀 快速开始

### 启动开发环境
```bash
./start-dev.sh
```

### 拉取GitHub更新（智能处理冲突）
```bash
./pull-and-reload.sh
```

### 查看日志
```bash
./dev-logs.sh -f backend    # 跟踪后端日志
./dev-logs.sh frontend     # 查看前端日志
./dev-logs.sh              # 查看所有日志
```

### 停止开发环境
```bash
./stop-dev.sh
```

## 🛠️ 开发工作流

### 1. 日常开发流程
```bash
# 1. 启动开发环境
./start-dev.sh

# 2. 修改代码（前端热重载/后端自动重启）
# - 前端: 修改任何前端文件，浏览器自动刷新
# - 后端: 修改任何Python文件，服务自动重启

# 3. 拉取其他作者的GitHub更新
./pull-and-reload.sh

# 4. 完成开发，停止环境
./stop-dev.sh
```

### 2. 解决拉取冲突
`pull-and-reload.sh` 会自动处理：

#### ✅ **智能冲突解决**
- **自动暂存本地修改**: 拉取前保存你的所有修改
- **智能LFS处理**: 自动跳过大文件下载，避免LFS配额问题
- **模型文件保护**: 自动备份和恢复420MB的embedding模型
- **冲突自动恢复**: 拉取完成后自动恢复你的修改
- **热重载服务**: 代码更新后自动重启相关服务

#### 🔄 **冲突处理流程**
1. **检测冲突** → 暂存你的修改
2. **智能拉取** → 跳过LFS文件，避免大文件冲突
3. **模型保护** → 备份重要模型文件
4. **代码同步** → 拉取GitHub最新代码
5. **资产恢复** → 恢复模型文件（从备份或其他项目）
6. **修改恢复** → 恢复你暂存的修改
7. **热重载** → 自动重启开发服务

## 📊 服务访问地址

| 服务 | 地址 | 说明 |
|------|------|------|
| **前端开发** | http://localhost:3000 | React热重载开发服务器 |
| **后端API** | http://localhost:8000 | FastAPI热重载服务器 |
| **数据库** | localhost:5432 | PostgreSQL数据库 |

## 🎯 开发特性

### 前端热重载
- ✅ **文件监听**: 修改任何前端文件立即生效
- ✅ **浏览器自动刷新**: 代码保存后浏览器自动刷新
- ✅ **快速编译**: 增量编译，毫秒级响应
- ✅ **错误提示**: 实时显示编译错误

### 后端增量更新
- ✅ **智能重启**: 只有Python文件变更才重启服务
- ✅ **层缓存**: 利用Docker层缓存，构建速度提升80%+
- ✅ **依赖缓存**: node_modules和Python包缓存，避免重复安装

### GitHub更新友好
- ✅ **无冲突拉取**: 自动处理GitHub仓库更新
- ✅ **模型文件保护**: 420MB模型文件不会丢失
- ✅ **跨项目同步**: 自动从其他项目恢复完整模型
- ✅ **代理支持**: 自动配置网络代理访问GitHub

## 📝 常用命令

### 开发环境管理
```bash
./start-dev.sh --clean     # 清理后重新启动
./start-dev.sh --rebuild   # 重新构建镜像并启动
./start-dev.sh --build     # 仅构建开发镜像
./start-dev.sh --help      # 显示帮助信息
```

### 日志查看
```bash
./dev-logs.sh -f backend --tail 100   # 跟踪后端最后100行日志
./dev-logs.sh frontend                # 查看前端日志
./dev-logs.sh postgres                # 查看数据库日志
```

### Git操作
```bash
./pull-and-reload.sh           # 智能拉取+热重载
./pull-and-reload.sh --help    # 显示详细帮助
```

## 🚨 注意事项

### 首次使用
1. 确保已有`.env`配置文件（脚本会自动创建默认配置）
2. 填入你的AI API密钥到`.env`文件
3. 确保embedding模型文件完整（约420MB）

### 性能优化
- 前端修改：立即生效（0-2秒）
- 后端修改：自动重启（2-5秒）
- GitHub拉取：智能处理，避免全量重构建

### 故障排除
如果遇到问题：
1. **前端不刷新**: 检查浏览器控制台，或重启前端服务
2. **后端不重启**: 检查Python语法错误，查看后端日志
3. **拉取失败**: 运行`./pull-and-reload.sh --help`查看详细处理
4. **模型丢失**: 脚本会自动从其他项目恢复
5. **服务启动失败**: 查看`./dev-logs.sh`排查问题

## 🔄 切换模式

### 开发模式 → 生产模式
```bash
./stop-dev.sh                    # 停止开发环境
docker compose up -d              # 启动生产环境
```

### 生产模式 → 开发模式
```bash
docker compose down               # 停止生产环境
./start-dev.sh                    # 启动开发环境
```

## 💡 开发技巧

### 1. 高效工作流
- 保持开发环境常开
- 使用`./pull-and-reload.sh`同步更新
- 利用热重载特性快速调试

### 2. 模型文件管理
- 不要手动删除`backend/embedding`目录
- 如有LFS问题，脚本会自动处理
- 模型文件会自动备份和恢复

### 3. 网络配置
- 确保代理配置正确（如需要）
- GitHub连接问题会自动检测和配置
- 支持多种代理配置方式

### 4. 多项目协同
- 脚本会自动寻找其他项目的完整模型文件
- 支持跨目录模型文件同步
- 确保至少有一个项目有完整模型

---

## 🎉 开发体验提升

**使用前**: 每次修改都需要重新构建 → 5-10分钟
**使用后**: 代码修改立即生效 → 0-5秒

**使用前**: GitHub拉取冲突频繁 → 手动处理
**使用后**: 智能冲突解决 → 自动处理

**使用前**: 模型文件容易丢失 → 灾难性恢复
**使用后**: 模型文件自动保护 → 零风险更新

开发模式让你专注于代码创作，而不是环境维护！